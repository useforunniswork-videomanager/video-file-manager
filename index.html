<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video File Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background: #f1f5f9; font-family: 'Inter', sans-serif; }
        .tooltip-custom { position: relative; }
        .tooltip-custom:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            z-index: 10;
            background: #212529;
            color: white;
            font-size: 0.75rem;
            border-radius: 0.25rem;
            padding: 0.5rem;
            margin-top: -2rem;
        }
        .progress-bar-custom { display: none; width: 100%; height: 3px; background: #e5e7eb; }
        .progress-bar-custom.active { display: block; }
        .progress-bar-custom div { height: 100%; background: #20c997; transition: width 0.3s; }
        video { max-width: 100%; height: auto; }
        .nav-tabs .nav-link.active { background-color: #20c997; color: white; border-bottom: 2px solid #1aa179; font-weight: 600; }
        .tab-content > .tab-pane { display: none; }
        .tab-content > .active { display: block; }
        th { position: sticky; top: 0; background-color: #d1f2eb; font-weight: 600; }
        textarea { resize: vertical; min-height: 80px; }
    </style>
</head>
<body class="min-vh-100">
    <div id="passwordPrompt" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-center" style="background: rgba(33, 37, 41, 0.75); z-index: 9999;">
        <div class="bg-white p-4 rounded shadow" style="max-width: 28rem; width: 100%;">
            <h2 class="fs-4 fw-semibold mb-3 text-dark">Welcome!</h2>
            <p class="text-secondary mb-3">Enter password to access Video File Manager.</p>
            <input type="password" id="passwordInput" class="form-control mb-3" placeholder="Password">
            <button id="loginButton" onclick="checkPassword()" class="btn btn-success w-100" disabled>Loading...</button>
        </div>
    </div>

    <div id="mainApp" class="container-fluid min-vh-100 d-none">
        <header class="bg-info bg-opacity-25 rounded shadow-sm mb-4 p-3">
            <h1 class="fs-2 fw-bold text-dark text-center">Video File Manager</h1>
            <p class="text-center text-secondary small mt-1">Organize, tag, and preview your video files with cloud sync!</p>
        </header>

        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#programmesTab" type="button">Programmes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#disksTab" type="button">Disks</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#scanTab" type="button">Scan HDD</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#scannedTab" type="button">Scanned Files</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#metadataTab" type="button">Metadata</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#searchTab" type="button">Search</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#exportTab" type="button">Export</button>
            </li>
        </ul>

        <main class="tab-content" id="mainTabContent">
            <section id="programmesTab" class="tab-pane fade show active bg-white p-4 rounded shadow-sm">
                <h2 class="fs-4 fw-semibold text-dark mb-3">Manage Programme Names</h2>
                <p class="text-secondary small mb-3">Add, edit, or remove programme names for tagging.</p>
                <div class="row g-3 mb-3">
                    <div class="col-md-8">
                        <input type="text" id="newProgramme" class="form-control" placeholder="Enter programme name">
                    </div>
                    <div class="col-md-4">
                        <button onclick="addProgramme()" class="btn btn-success w-100">Add Programme</button>
                    </div>
                </div>
                <div id="programmeList" class="d-flex flex-column gap-3"></div>
                <p id="noProgrammesMessage" class="text-secondary small mt-3 d-none">No programmes available. Add a programme above to start tagging files.</p>
            </section>

            <section id="disksTab" class="tab-pane fade bg-white p-4 rounded shadow-sm">
                <h2 class="fs-4 fw-semibold text-dark mb-3">Scanned Disks</h2>
                <p class="text-secondary small mb-3">View all scanned Disk IDs and rescan for new programmes.</p>
                <div id="diskList" class="d-flex flex-column gap-3"></div>
            </section>

            <section id="scanTab" class="tab-pane fade bg-white p-4 rounded shadow-sm">
                <h2 class="fs-4 fw-semibold text-dark mb-3">Select HDD and Scan</h2>
                <p class="text-secondary small mb-3">Choose a folder (including subfolders) and assign a Disk ID.</p>
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" id="diskId" class="form-control" placeholder="Disk ID (e.g., 117-HD2TB)">
                    </div>
                    <div class="col-md-4">
                        <input type="file" id="diskFolder" webkitdirectory directory multiple class="form-control">
                    </div>
                    <div class="col-md-4">
                        <button onclick="scanDisk()" class="btn btn-success w-100">Scan Videos</button>
                    </div>
                </div>
                <div class="progress-bar-custom mt-4" id="scanProgress">
                    <div id="progressFill" style="width: 0%;"></div>
                </div>
            </section>

            <section id="scannedTab" class="tab-pane fade bg-white p-4 rounded shadow-sm">
                <h2 class="fs-4 fw-semibold text-dark mb-3">Scanned Video Files</h2>
                <p class="text-secondary small mb-3">View unarchived video files from selected folder and subfolders, sorted alphabetically.</p>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-3">
                        <thead class="table-success">
                            <tr>
                                <th class="w-75">Relative File Path</th>
                                <th class="w-25">Action</th>
                            </tr>
                        </thead>
                        <tbody id="scannedTable"></tbody>
                    </table>
                </div>
            </section>

            <section id="metadataTab" class="tab-pane fade bg-white p-4 rounded shadow-sm">
                <h2 class="fs-4 fw-semibold text-dark mb-3">Manage Metadata</h2>
                <p class="text-secondary small mb-3">Add or edit metadata while previewing the video. Episode Details are auto-corrected to sentence case on save.</p>
                <input type="text" id="metadataFilePath" class="form-control mb-4" placeholder="Selected relative file path" readonly>
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="mb-3">
                            <label class="form-label">Name of Programme</label>
                            <select id="programName" onchange="toggleOtherProgrammeInput(this)" class="form-select">
                                <option value="">Select a programme</option>
                            </select>
                            <input type="text" id="otherProgramme" placeholder="Enter new programme" class="form-control mt-2 d-none">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Episode Number</label>
                            <input type="number" id="episodeNumber" placeholder="e.g., 1" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Episode Details</label>
                            <textarea id="episodeDetails" placeholder="e.g., Episode 1, 30min, Drama, Directed by John Doe" rows="4" class="form-control"></textarea>
                            <button onclick="checkGrammar()" class="btn btn-warning mt-2">Check Grammar</button>
                            <div id="grammarSuggestions" class="text-secondary small mt-2 d-none"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Telecast Date</label>
                            <input type="date" id="telecastDate" class="form-control">
                        </div>
                        <div id="customFields" class="d-flex flex-column gap-3 mb-3">
                            <div class="d-flex gap-2">
                                <input type="text" placeholder="Custom Field Name" class="form-control" data-key>
                                <input type="text" placeholder="Value" class="form-control" data-value>
                                <button onclick="removeCustomField(this)" class="btn btn-danger">Remove</button>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button onclick="addCustomField()" class="btn btn-success">Add Custom Field</button>
                            <button onclick="saveMetadata()" class="btn btn-primary">Save Metadata</button>
                        </div>
                    </div>
                    <div class="col-lg-6" id="videoPlayerContainer" style="display: none;">
                        <h3 class="fs-5 fw-semibold text-dark mb-2">Video Preview</h3>
                        <video id="videoPlayer" controls class="border rounded shadow-sm w-100"></video>
                    </div>
                </div>
            </section>

            <section id="searchTab" class="tab-pane fade bg-white p-4 rounded shadow-sm">
                <h2 class="fs-4 fw-semibold text-dark mb-3">Search Files</h2>
                <p class="text-secondary small mb-3">Find archived files by Disk ID, programme name, episode number, telecast date, or other metadata (e.g., details). Use AND (all criteria must match) or OR (any criterion matches). Results are sorted by programme and episode number.</p>
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <input type="text" id="searchDiskId" class="form-control" placeholder="Search Disk ID (e.g., 117-HD2TB)">
                    </div>
                    <div class="col-md-2">
                        <select id="searchProgramName" class="form-select">
                            <option value="">All Programmes</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" id="searchEpisodeNumber" class="form-control" placeholder="Episode Number (e.g., 1)">
                    </div>
                    <div class="col-md-2">
                        <input type="date" id="searchTelecastDate" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <input type="text" id="searchMetadata" class="form-control" placeholder="Search Metadata (e.g., Drama, Sci-Fi)">
                    </div>
                    <div class="col-md-1">
                        <select id="searchLogic" class="form-select">
                            <option value="AND">AND</option>
                            <option value="OR">OR</option>
                        </select>
                    </div>
                </div>
                <button onclick="searchFiles()" class="btn btn-success">Search Files</button>
                <input type="file" id="copyDestination" webkitdirectory directory class="d-none">
            </section>

            <section id="exportTab" class="tab-pane fade bg-white p-4 rounded shadow-sm">
                <h2 class="fs-4 fw-semibold text-dark mb-3">Export and Backup</h2>
                <p class="text-secondary small mb-3">Export metadata as CSV, backup data as JSON, or restore from JSON.</p>
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <button onclick="exportReport()" class="btn btn-success w-100">Export as CSV</button>
                    </div>
                    <div class="col-md-6">
                        <button onclick="backupData()" class="btn btn-primary w-100">Backup Data</button>
                    </div>
                    <div class="col-md-6">
                        <input type="file" id="restoreInput" accept=".json" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <button onclick="restoreData()" class="btn btn-success w-100">Restore Data</button>
                    </div>
                </div>
            </section>

            <section id="results" class="bg-white p-4 rounded shadow-sm mt-4">
                <h2 class="fs-4 fw-semibold text-dark mb-3">Archived Files</h2>
                <p class="text-secondary small mb-3">View all files with metadata, sorted by programme and episode number. Use Disk ID to locate HDD. Green rows indicate accessible files; red rows indicate missing files (reselect folder or update path).</p>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-success">
                            <tr>
                                <th style="width: 35%;">Relative File Path</th>
                                <th style="width: 15%;">Disk ID</th>
                                <th style="width: 35%;">Metadata</th>
                                <th style="width: 15%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fileTable"></tbody>
                    </table>
                </div>
            </section>
        </main>

        <footer class="bg-info bg-opacity-25 rounded shadow-sm mt-4 text-center text-secondary small p-3">
            <p class="mb-0">Video File Manager v2.6 | Built for secure video organization with cloud sync | September 29, 2025</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBd2ymMz7Az97T71xsnP3P2XFjTrxEzruc",
            authDomain: "video-manager-sync.firebaseapp.com",
            projectId: "video-manager-sync",
            storageBucket: "video-manager-sync.firebasestorage.app",
            messagingSenderId: "772995186320",
            appId: "1:772995186320:web:42842957d19e780ebea215",
            measurementId: "G-KZ3C92XLJH"
        };

        window.firebaseInitialized = null;

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                const firestore = getFirestore(app);
                const auth = getAuth(app);
                window.firebase = {
                    app, firestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, writeBatch, auth, signInAnonymously, onAuthStateChanged
                };
                console.log('Firebase initialized successfully:', firebaseConfig.projectId);
                document.getElementById('loginButton').disabled = false;
                document.getElementById('loginButton').textContent = 'Log In';
                return { app, firestore, auth };
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                alert('Failed to initialize Firebase. Please check your Firebase configuration and reload the page.');
                document.getElementById('loginButton').disabled = true;
                document.getElementById('loginButton').textContent = 'Initialization Failed';
                throw error;
            }
        }

        async function attemptSignIn(auth, attempt = 1, maxAttempts = 3) {
            try {
                const userCredential = await signInAnonymously(auth);
                console.log('Authenticated successfully:', userCredential.user.uid);
                return userCredential.user;
            } catch (error) {
                console.error(`Authentication attempt ${attempt} failed:`, error);
                if (attempt < maxAttempts) {
                    console.log(`Retrying authentication (${attempt + 1}/${maxAttempts})...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return attemptSignIn(auth, attempt + 1, maxAttempts);
                } else {
                    console.error('Authentication failed after max attempts:', error);
                    alert('Failed to authenticate with Firebase. Please ensure anonymous authentication is enabled and try again.');
                    throw error;
                }
            }
        }

        window.firebaseInitialized = initializeFirebase().catch(error => {
            console.error('Initialization failed:', error);
        });
    </script>

    <script>
        async function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            if (password !== 'securepass') {
                alert('Incorrect password. Please try again.');
                return;
            }

            try {
                await window.firebaseInitialized;
                if (!window.firebase || !window.firebase.firestore || !window.firebase.auth || !window.firebase.onAuthStateChanged) {
                    console.error('Firebase not initialized properly:', window.firebase);
                    alert('Firebase is not initialized. Please check Firebase configuration and reload the page.');
                    return;
                }

                await window.firebase.signInAnonymously(window.firebase.auth);

                window.firebase.onAuthStateChanged(window.firebase.auth, async user => {
                    if (user) {
                        console.log('User authenticated:', user.uid);
                        document.getElementById('passwordPrompt').classList.add('d-none');
                        document.getElementById('mainApp').classList.remove('d-none');

                        try {
                            const snapshot = await window.firebase.getDocs(window.firebase.collection(window.firebase.firestore, 'programmes'));
                            if (snapshot.empty) {
                                const defaultProgrammes = ['Stranger Things', 'The Mandalorian', 'FRIENDS', 'Samantharangal'];
                                const batch = window.firebase.writeBatch(window.firebase.firestore);
                                defaultProgrammes.forEach(name => {
                                    const id = window.firebase.doc(window.firebase.collection(window.firebase.firestore, 'programmes')).id;
                                    batch.set(window.firebase.doc(window.firebase.firestore, 'programmes', id), { id, name });
                                });
                                await batch.commit();
                            }

                            window.firebase.onSnapshot(window.firebase.collection(window.firebase.firestore, 'programmes'), () => {
                                loadProgrammes();
                            }, error => {
                                console.error('Programmes snapshot error:', error);
                                alert('Error receiving programme updates. Please check Firebase configuration.');
                            });

                            window.firebase.onSnapshot(window.firebase.collection(window.firebase.firestore, 'files'), () => {
                                loadFiles();
                                loadDisks();
                            }, error => {
                                console.error('Files snapshot error:', error);
                                alert('Error receiving file updates. Please check Firebase configuration.');
                            });

                            await loadProgrammes();
                            await loadFiles();
                            await loadDisks();
                        } catch (error) {
                            console.error('Error loading app data:', error);
                            alert('Error loading app. Please check Firebase configuration and try again.');
                        }
                    } else {
                        console.error('No user authenticated.');
                        alert('Authentication failed. Please ensure anonymous authentication is enabled in Firebase Console and try again.');
                    }
                }, error => {
                    console.error('Auth state change error:', error);
                    alert('Error checking authentication state. Please try again.');
                });
            } catch (error) {
                console.error('Firebase initialization not completed:', error);
                alert('Firebase initialization failed. Please reload the page and try again.');
            }
        }

        const VIDEO_EXTENSIONS = ['.mp4', '.mkv', '.avi', '.mov', '.wmv'];
        const EXCLUDE_PREFIXES = ['.', '$', '~'];
        const EXCLUDE_DIRS = ['/Windows', '/System32', '/dev', '/proc', '/sys', '/boot', '/etc'];
        let currentFiles = [];

        function sanitizeId(path) {
            return path.replace(/[\/: ]/g, '_').replace(/[^a-zA-Z0-9._-]/g, '');
        }

        function normalizePath(filePath) {
            if (!filePath) return '';
            return filePath
                .replace(/^[a-zA-Z]:[\\\/]/, '')
                .replace(/\\/g, '/')
                .replace(/^\/+|\/+$/g, '')
                .toLowerCase();
        }

        async function updateFilePath(oldPath, diskId) {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.updateDoc || !window.firebase.doc || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.webkitdirectory = true;
            fileInput.directory = true;
            fileInput.multiple = true;
            fileInput.onchange = async () => {
                const files = Array.from(fileInput.files);
                const normalizedOldPath = normalizePath(oldPath);
                const matchingFile = files.find(f => normalizePath(f.webkitRelativePath) === normalizedOldPath);
                if (!matchingFile) {
                    alert('Selected folder does not contain the file. Please select the correct folder.');
                    console.error(`No match found for ${normalizedOldPath} in selected files:`, files.map(f => normalizePath(f.webkitRelativePath)));
                    return;
                }
                try {
                    const snapshot = await window.firebase.getDocs(window.firebase.query(window.firebase.collection(window.firebase.firestore, 'files'), window.firebase.where('filePath', '==', oldPath)));
                    if (snapshot.empty) {
                        alert('File not found in Firestore.');
                        return;
                    }
                    const docRef = snapshot.docs[0].ref;
                    const newPath = normalizePath(matchingFile.webkitRelativePath);
                    await window.firebase.updateDoc(docRef, { filePath: newPath });
                    console.log(`Updated path from ${oldPath} to ${newPath}`);
                    alert(`File path updated for "${newPath.split('/').pop()}".`);
                    currentFiles = [...currentFiles, ...files];
                    await loadFiles();
                } catch (error) {
                    console.error('Failed to update file path:', error);
                    alert('Error updating file path. Please check Firebase configuration and try again.');
                }
            };
            fileInput.click();
        }

        window.addEventListener('beforeunload', function(event) {
            event.preventDefault();
            event.returnValue = 'Would you like to back up your data before closing? Go to the Export tab and click "Backup Data" to save as JSON.';
        });

        function toSentenceCase(text) {
            if (!text) return text;
            return text
                .split(/([.!?]\s+)/)
                .map(segment => {
                    if (/[.!?]\s+$/.test(segment)) return segment;
                    return segment.charAt(0).toUpperCase() + segment.slice(1).toLowerCase();
                })
                .join('')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function checkGrammar() {
            const episodeDetails = document.getElementById('episodeDetails').value.trim();
            const suggestionsDiv = document.getElementById('grammarSuggestions');
            suggestionsDiv.classList.add('d-none');
            suggestionsDiv.innerHTML = '';

            if (!episodeDetails) {
                suggestionsDiv.innerHTML = 'No text to check.';
                suggestionsDiv.classList.remove('d-none');
                return;
            }

            const suggestions = [];
            const words = episodeDetails.toLowerCase().split(/\s+/);
            const commonErrors = {
                'direct': 'directed',
                'directs': 'directed',
                'was': 'were (if plural subject)',
                'is': 'are (if plural subject)',
                'dont': "don't",
                'ep': 'episode',
                'min': 'minutes'
            };

            words.forEach((word, index) => {
                if (commonErrors[word]) {
                    suggestions.push(`Replace "${word}" with "${commonErrors[word]}" at position ${index + 1}.`);
                }
                if (index === 0 && word.match(/^[a-z]/)) {
                    suggestions.push(`Capitalize the first word "${word}" to "${word.charAt(0).toUpperCase() + word.slice(1)}".`);
                }
                if (word === 'a' && index < words.length - 1 && words[index + 1].match(/^[aeiou]/i)) {
                    suggestions.push(`Replace "a" with "an" before "${words[index + 1]}" at position ${index + 1}.`);
                }
            });

            if (!episodeDetails.match(/[.!?]$/)) {
                suggestions.push('Add a period, exclamation mark, or question mark at the end of the text.');
            }

            if (suggestions.length === 0) {
                suggestionsDiv.innerHTML = 'No grammar issues found.';
            } else {
                suggestionsDiv.innerHTML = '<p class="fw-semibold">Grammar Suggestions:</p><ul class="list-unstyled ps-3">' +
                    suggestions.map(s => `<li>• ${s}</li>`).join('') + '</ul>';
            }
            suggestionsDiv.classList.remove('d-none');
        }

        async function loadProgrammes() {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            try {
                const snapshot = await window.firebase.getDocs(window.firebase.collection(window.firebase.firestore, 'programmes'));
                console.log('Programmes fetched:', snapshot.size);
                const programmes = snapshot.docs.map(doc => doc.data());
                const metadataSelect = document.getElementById('programName');
                const searchSelect = document.getElementById('searchProgramName');
                const noProgrammesMessage = document.getElementById('noProgrammesMessage');
                metadataSelect.innerHTML = `<option value="">Select a programme</option>`;
                searchSelect.innerHTML = `<option value="">All Programmes</option>`;
                programmes.forEach(p => {
                    metadataSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`;
                    searchSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`;
                });
                metadataSelect.innerHTML += `<option value="Other">Other</option>`;
                noProgrammesMessage.classList.toggle('d-none', programmes.length > 0);

                const list = document.getElementById('programmeList');
                list.innerHTML = '';
                programmes.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'd-flex gap-2 align-items-center';
                    div.innerHTML = `
                        <input type="text" value="${p.name}" class="form-control" readonly>
                        <button onclick="editProgramme('${p.id}', this)" class="btn btn-warning">Edit</button>
                        <button onclick="deleteProgramme('${p.id}')" class="btn btn-danger">Delete</button>
                    `;
                    list.appendChild(div);
                });
            } catch (error) {
                console.error('Failed to load programmes:', error);
                alert('Error loading programmes. Please check Firebase configuration and try again.');
            }
        }

        async function loadDisks
