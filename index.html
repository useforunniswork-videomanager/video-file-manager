<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video File Manager</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            background: #f1f5f9;
            font-family: 'Inter', sans-serif;
        }

        .card-custom {
            border-radius: 1rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .tab-content-section {
            display: none;
        }

        .tab-content-section.active {
            display: block;
        }

        .tab-button.active {
            background-color: #14b8a6 !important;
            color: #fff !important;
            font-weight: 600;
        }

        .progress-bar-custom {
            height: 4px;
            background-color: #e5e7eb;
            display: none;
        }

        .progress-bar-custom.active {
            display: block;
        }

        .progress-bar-custom div {
            height: 100%;
            background: #2dd4bf;
            transition: width 0.3s;
        }

        .tooltip-custom[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            background: #333;
            color: #fff;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            top: -30px;
            white-space: nowrap;
        }

        table th {
            background: #f0fdfa;
            position: sticky;
            top: 0;
        }

        table td,
        table th {
            padding: 0.75rem;
            border: 1px solid #dee2e6;
        }

        .btn-teal {
            background-color: #14b8a6;
            color: #fff;
        }

        .btn-teal:hover {
            background-color: #0d9488;
            color: #fff;
        }

        .bg-teal-100 {
            background-color: #ccfbf1;
        }
    </style>
</head>

<body class="min-vh-100">

    <!-- Password Prompt -->
    <div id="passwordPrompt"
        class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex justify-content-center align-items-center">
        <div class="card p-4 shadow-lg w-100" style="max-width:400px;">
            <h2 class="h4 fw-bold text-dark mb-3">Welcome!</h2>
            <p class="text-muted">Enter password to access Video File Manager.</p>
            <input type="password" id="passwordInput" class="form-control mb-3" placeholder="Password">
            <button id="loginButton" onclick="checkPassword()" class="btn btn-teal w-100" disabled>Loading...</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container py-4 d-none">

        <!-- Header -->
        <header class="card-custom bg-teal-100 text-center p-4 mb-4">
            <h1 class="fw-bold text-dark">Video File Manager</h1>
            <p class="text-muted small">Organize, tag, and preview your video files with cloud sync!</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="d-flex flex-wrap border-bottom mb-4">
            <button class="btn flex-fill border-0 py-2 tab-button active"
                onclick="showTab('programmesTab')">Programmes</button>
            <button class="btn flex-fill border-0 py-2 tab-button" onclick="showTab('disksTab')">Disks</button>
            <button class="btn flex-fill border-0 py-2 tab-button" onclick="showTab('scanTab')">Scan HDD</button>
            <button class="btn flex-fill border-0 py-2 tab-button" onclick="showTab('scannedTab')">Scanned
                Files</button>
            <button class="btn flex-fill border-0 py-2 tab-button" onclick="showTab('metadataTab')">Metadata</button>
            <button class="btn flex-fill border-0 py-2 tab-button" onclick="showTab('searchTab')">Search</button>
            <button class="btn flex-fill border-0 py-2 tab-button" onclick="showTab('exportTab')">Export</button>
        </nav>

        <!-- Tab Contents -->
        <main class="mb-5">

            <!-- Programmes -->
            <section id="programmesTab" class="tab-content-section active card card-custom p-4 mb-4">
                <h2 class="h5 fw-semibold text-dark mb-3">Manage Programme Names</h2>
                <p class="text-muted small">Add, edit, or remove programme names for tagging.</p>
                <div class="row g-2 mb-3">
                    <div class="col-md-8">
                        <input type="text" id="newProgramme" class="form-control" placeholder="Enter programme name">
                    </div>
                    <div class="col-md-4">
                        <button onclick="addProgramme()" class="btn btn-teal w-100">Add Programme</button>
                    </div>
                </div>
                <div id="programmeList" class="d-grid gap-2"></div>
                <p id="noProgrammesMessage" class="text-muted small d-none mt-2">No programmes available. Add a
                    programme above to start tagging files.</p>
            </section>

            <!-- Disks -->
            <section id="disksTab" class="tab-content-section card card-custom p-4 mb-4">
                <h2 class="h5 fw-semibold text-dark mb-3">Scanned Disks</h2>
                <p class="text-muted small">View all scanned Disk IDs and rescan for new programmes.</p>
                <div id="diskList" class="d-grid gap-2"></div>
            </section>

            <!-- Scan HDD -->
            <section id="scanTab" class="tab-content-section card card-custom p-4 mb-4">
                <h2 class="h5 fw-semibold text-dark mb-3">Select HDD and Scan</h2>
                <p class="text-muted small">Choose a folder (including subfolders) and assign a Disk ID.</p>
                <div class="row g-2">
                    <div class="col-md-4"><input type="text" id="diskId" class="form-control"
                            placeholder="Disk ID (e.g., 117-HD2TB)"></div>
                    <div class="col-md-5"><input type="file" id="diskFolder" webkitdirectory directory multiple
                            class="form-control"></div>
                    <div class="col-md-3"><button onclick="scanDisk()" class="btn btn-teal w-100">Scan Videos</button>
                    </div>
                </div>
                <div class="progress-bar-custom mt-3" id="scanProgress">
                    <div id="progressFill" class="w-0"></div>
                </div>
            </section>

            <!-- Scanned Files -->
            <section id="scannedTab" class="tab-content-section card card-custom p-4 mb-4">
                <h2 class="h5 fw-semibold text-dark mb-3">Scanned Video Files</h2>
                <p class="text-muted small">View unarchived video files from folder/subfolders.</p>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Relative File Path</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="scannedTable"></tbody>
                    </table>
                </div>
            </section>

            <!-- Metadata -->
            <section id="metadataTab" class="tab-content-section card card-custom p-4 mb-4">
                <h2 class="h5 fw-semibold text-dark mb-3">Manage Metadata</h2>
                <input type="text" id="metadataFilePath" class="form-control mb-3" placeholder="Selected file path"
                    readonly>
                <div class="row g-3">
                    <div class="col-lg-6" id="metadataFields">
                        <!-- Programme, Episode, Details, Telecast, Custom Fields -->
                        <!-- Buttons: Save, Add Field -->
                    </div>
                    <div class="col-lg-6 d-none" id="videoPlayerContainer">
                        <h5>Video Preview</h5>
                        <video id="videoPlayer" controls class="w-100 border rounded"></video>
                    </div>
                </div>
            </section>

            <!-- Search -->
            <section id="searchTab" class="tab-content-section card card-custom p-4 mb-4">
                <h2 class="h5 fw-semibold text-dark mb-3">Search Files</h2>
                <div class="row g-2 mb-3">
                    <div class="col-md-2"><input type="text" id="searchDiskId" class="form-control"
                            placeholder="Disk ID"></div>
                    <div class="col-md-2"><select id="searchProgramName" class="form-select">
                            <option>All Programmes</option>
                        </select></div>
                    <div class="col-md-2"><input type="number" id="searchEpisodeNumber" class="form-control"
                            placeholder="Episode #"></div>
                    <div class="col-md-2"><input type="date" id="searchTelecastDate" class="form-control"></div>
                    <div class="col-md-2"><input type="text" id="searchMetadata" class="form-control"
                            placeholder="Metadata"></div>
                    <div class="col-md-2"><select id="searchLogic" class="form-select">
                            <option value="AND">AND</option>
                            <option value="OR">OR</option>
                        </select></div>
                </div>
                <button onclick="searchFiles()" class="btn btn-teal">Search</button>
            </section>

            <!-- Export -->
            <section id="exportTab" class="tab-content-section card card-custom p-4 mb-4">
                <h2 class="h5 fw-semibold text-dark mb-3">Export and Backup</h2>
                <div class="row g-2">
                    <div class="col-md-6"><button onclick="exportReport()" class="btn btn-teal w-100">Export as
                            CSV</button></div>
                    <div class="col-md-6"><button onclick="backupData()" class="btn btn-primary w-100">Backup
                            Data</button></div>
                    <div class="col-md-8"><input type="file" id="restoreInput" accept=".json" class="form-control">
                    </div>
                    <div class="col-md-4"><button onclick="restoreData()" class="btn btn-success w-100">Restore</button>
                    </div>
                </div>
            </section>

            <!-- Results -->
            <section id="results" class="card card-custom p-4">
                <h2 class="h5 fw-semibold text-dark mb-3">Archived Files</h2>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>File Path</th>
                                <th>Disk ID</th>
                                <th>Metadata</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fileTable"></tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="text-center text-muted small mt-4 py-3 card-custom bg-teal-100">
            <p>Video File Manager v2.6 | Built for secure video organization with cloud sync | September 29, 2025</p>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBd2ymMz7Az97T71xsnP3P2XFjTrxEzruc",
            authDomain: "video-manager-sync.firebaseapp.com",
            projectId: "video-manager-sync",
            storageBucket: "video-manager-sync.firebasestorage.app",
            messagingSenderId: "772995186320",
            appId: "1:772995186320:web:42842957d19e780ebea215",
            measurementId: "G-KZ3C92XLJH"
        };

        window.firebaseInitialized = null;

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                const firestore = getFirestore(app);
                const auth = getAuth(app);
                window.firebase = {
                    app,
                    firestore,
                    collection,
                    getDocs,
                    doc,
                    setDoc,
                    updateDoc,
                    deleteDoc,
                    onSnapshot,
                    query,
                    where,
                    writeBatch,
                    auth,
                    signInAnonymously,
                    onAuthStateChanged
                };
                console.log('Firebase initialized successfully:', firebaseConfig.projectId);
                document.getElementById('loginButton').disabled = false;
                document.getElementById('loginButton').textContent = 'Log In';
                return { app, firestore, auth };
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                alert('Failed to initialize Firebase. Please check your Firebase configuration and reload the page.');
                document.getElementById('loginButton').disabled = true;
                document.getElementById('loginButton').textContent = 'Initialization Failed';
                throw error;
            }
        }

        async function attemptSignIn(auth, attempt = 1, maxAttempts = 3) {
            try {
                const userCredential = await signInAnonymously(auth);
                console.log('Authenticated successfully:', userCredential.user.uid);
                return userCredential.user;
            } catch (error) {
                console.error(`Authentication attempt ${attempt} failed:`, error);
                if (attempt < maxAttempts) {
                    console.log(`Retrying authentication (${attempt + 1}/${maxAttempts})...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return attemptSignIn(auth, attempt + 1, maxAttempts);
                } else {
                    console.error('Authentication failed after max attempts:', error);
                    alert('Failed to authenticate with Firebase. Please ensure anonymous authentication is enabled and try again.');
                    throw error;
                }
            }
        }

        window.firebaseInitialized = initializeFirebase().catch(error => {
            console.error('Initialization failed:', error);
        });
    </script>

    <script>
        async function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            if (password !== 'securepass') {
                alert('Incorrect password. Please try again.');
                return;
            }

            try {
                await window.firebaseInitialized;
                if (!window.firebase || !window.firebase.firestore || !window.firebase.auth || !window.firebase.onAuthStateChanged) {
                    console.error('Firebase not initialized properly:', window.firebase);
                    alert('Firebase is not initialized. Please check Firebase configuration and reload the page.');
                    return;
                }

                await window.firebase.signInAnonymously(window.firebase.auth);

                window.firebase.onAuthStateChanged(window.firebase.auth, async user => {
                    if (user) {
                        console.log('User authenticated:', user.uid);
                        document.getElementById('passwordPrompt').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');

                        try {
                            const snapshot = await window.firebase.getDocs(window.firebase.collection(window.firebase.firestore, 'programmes'));
                            if (snapshot.empty) {
                                const defaultProgrammes = ['Stranger Things', 'The Mandalorian', 'FRIENDS', 'Samantharangal'];
                                const batch = window.firebase.writeBatch(window.firebase.firestore);
                                defaultProgrammes.forEach(name => {
                                    const id = window.firebase.doc(window.firebase.collection(window.firebase.firestore, 'programmes')).id;
                                    batch.set(window.firebase.doc(window.firebase.firestore, 'programmes', id), { id, name });
                                });
                                await batch.commit();
                            }

                            window.firebase.onSnapshot(window.firebase.collection(window.firebase.firestore, 'programmes'), () => {
                                loadProgrammes();
                            }, error => {
                                console.error('Programmes snapshot error:', error);
                                alert('Error receiving programme updates. Please check Firebase configuration.');
                            });

                            window.firebase.onSnapshot(window.firebase.collection(window.firebase.firestore, 'files'), () => {
                                loadFiles();
                                loadDisks();
                            }, error => {
                                console.error('Files snapshot error:', error);
                                alert('Error receiving file updates. Please check Firebase configuration.');
                            });

                            await loadProgrammes();
                            await loadFiles();
                            await loadDisks();
                        } catch (error) {
                            console.error('Error loading app data:', error);
                            alert('Error loading app. Please check Firebase configuration and try again.');
                        }
                    } else {
                        console.error('No user authenticated.');
                        alert('Authentication failed. Please ensure anonymous authentication is enabled in Firebase Console and try again.');
                    }
                }, error => {
                    console.error('Auth state change error:', error);
                    alert('Error checking authentication state. Please try again.');
                });
            } catch (error) {
                console.error('Firebase initialization not completed:', error);
                alert('Firebase initialization failed. Please reload the page and try again.');
            }
        }

        const VIDEO_EXTENSIONS = ['.mp4', '.mkv', '.avi', '.mov', '.wmv'];
        const EXCLUDE_PREFIXES = ['.', '$', '~'];
        const EXCLUDE_DIRS = ['/Windows', '/System32', '/dev', '/proc', '/sys', '/boot', '/etc'];
        let currentFiles = [];

        function sanitizeId(path) {
            return path.replace(/[\/: ]/g, '_').replace(/[^a-zA-Z0-9._-]/g, '');
        }

        function normalizePath(filePath) {
            if (!filePath) return '';
            return filePath
                .replace(/^[a-zA-Z]:[\\\/]/, '')
                .replace(/\\/g, '/')
                .replace(/^\/+|\/+$/g, '')
                .toLowerCase();
        }

        async function updateFilePath(oldPath, diskId) {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.updateDoc || !window.firebase.doc || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.webkitdirectory = true;
            fileInput.directory = true;
            fileInput.multiple = true;
            fileInput.onchange = async () => {
                const files = Array.from(fileInput.files);
                const normalizedOldPath = normalizePath(oldPath);
                const matchingFile = files.find(f => normalizePath(f.webkitRelativePath) === normalizedOldPath);
                if (!matchingFile) {
                    alert('Selected folder does not contain the file. Please select the correct folder.');
                    console.error(`No match found for ${normalizedOldPath} in selected files:`, files.map(f => normalizePath(f.webkitRelativePath)));
                    return;
                }
                try {
                    const snapshot = await window.firebase.getDocs(window.firebase.query(window.firebase.collection(window.firebase.firestore, 'files'), window.firebase.where('filePath', '==', oldPath)));
                    if (snapshot.empty) {
                        alert('File not found in Firestore.');
                        return;
                    }
                    const docRef = snapshot.docs[0].ref;
                    const newPath = normalizePath(matchingFile.webkitRelativePath);
                    await window.firebase.updateDoc(docRef, { filePath: newPath });
                    console.log(`Updated path from ${oldPath} to ${newPath}`);
                    alert(`File path updated for "${newPath.split('/').pop()}".`);
                    currentFiles = [...currentFiles, ...files];
                    await loadFiles();
                } catch (error) {
                    console.error('Failed to update file path:', error);
                    alert('Error updating file path. Please check Firebase configuration and try again.');
                }
            };
            fileInput.click();
        }

        window.addEventListener('beforeunload', function (event) {
            event.preventDefault();
            event.returnValue = 'Would you like to back up your data before closing? Go to the Export tab and click "Backup Data" to save as JSON.';
        });

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        function toSentenceCase(text) {
            if (!text) return text;
            return text
                .split(/([.!?]\s+)/)
                .map(segment => {
                    if (/[.!?]\s+$/.test(segment)) return segment;
                    return segment.charAt(0).toUpperCase() + segment.slice(1).toLowerCase();
                })
                .join('')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function checkGrammar() {
            const episodeDetails = document.getElementById('episodeDetails').value.trim();
            const suggestionsDiv = document.getElementById('grammarSuggestions');
            suggestionsDiv.classList.add('hidden');
            suggestionsDiv.innerHTML = '';

            if (!episodeDetails) {
                suggestionsDiv.innerHTML = 'No text to check.';
                suggestionsDiv.classList.remove('hidden');
                return;
            }

            const suggestions = [];
            const words = episodeDetails.toLowerCase().split(/\s+/);
            const commonErrors = {
                'direct': 'directed',
                'directs': 'directed',
                'was': 'were (if plural subject)',
                'is': 'are (if plural subject)',
                'dont': "don't",
                'ep': 'episode',
                'min': 'minutes'
            };

            words.forEach((word, index) => {
                if (commonErrors[word]) {
                    suggestions.push(`Replace "${word}" with "${commonErrors[word]}" at position ${index + 1}.`);
                }
                if (index === 0 && word.match(/^[a-z]/)) {
                    suggestions.push(`Capitalize the first word "${word}" to "${word.charAt(0).toUpperCase() + word.slice(1)}".`);
                }
                if (word === 'a' && index < words.length - 1 && words[index + 1].match(/^[aeiou]/i)) {
                    suggestions.push(`Replace "a" with "an" before "${words[index + 1]}" at position ${index + 1}.`);
                }
            });

            if (!episodeDetails.match(/[.!?]$/)) {
                suggestions.push('Add a period, exclamation mark, or question mark at the end of the text.');
            }

            if (suggestions.length === 0) {
                suggestionsDiv.innerHTML = 'No grammar issues found.';
            } else {
                suggestionsDiv.innerHTML = '<p class="font-semibold">Grammar Suggestions:</p><ul class="list-disc pl-5">' +
                    suggestions.map(s => `<li>${s}</li>`).join('') + '</ul>';
            }
            suggestionsDiv.classList.remove('hidden');
        }

        async function loadProgrammes() {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            try {
                const snapshot = await window.firebase.getDocs(window.firebase.collection(window.firebase.firestore, 'programmes'));
                console.log('Programmes fetched:', snapshot.size);
                const programmes = snapshot.docs.map(doc => doc.data());
                const metadataSelect = document.getElementById('programName');
                const searchSelect = document.getElementById('searchProgramName');
                const noProgrammesMessage = document.getElementById('noProgrammesMessage');
                metadataSelect.innerHTML = `<option value="">Select a programme</option>`;
                searchSelect.innerHTML = `<option value="">All Programmes</option>`;
                programmes.forEach(p => {
                    metadataSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`;
                    searchSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`;
                });
                metadataSelect.innerHTML += `<option value="Other">Other</option>`;
                noProgrammesMessage.classList.toggle('hidden', programmes.length > 0);

                const list = document.getElementById('programmeList');
                list.innerHTML = '';
                programmes.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'flex gap-3 items-center';
                    div.innerHTML = `
                        <input type="text" value="${p.name}" class="p-2 border rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-teal-300" readonly>
                        <button onclick="editProgramme('${p.id}', this)" class="bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600 transition tooltip" data-tooltip="Edit programme">Edit</button>
                        <button onclick="deleteProgramme('${p.id}')" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition tooltip" data-tooltip="Delete programme">Delete</button>
                    `;
                    list.appendChild(div);
                });
            } catch (error) {
                console.error('Failed to load programmes:', error);
                alert('Error loading programmes. Please check Firebase configuration and try again.');
            }
        }

        async function loadDisks() {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            try {
                const snapshot = await window.firebase.getDocs(window.firebase.collection(window.firebase.firestore, 'files'));
                console.log('Disks fetched:', snapshot.size);
                const files = snapshot.docs.map(doc => doc.data());
                const diskIds = [...new Set(files.map(file => file.diskId))];
                const diskList = document.getElementById('diskList');
                diskList.innerHTML = '';
                diskIds.forEach(diskId => {
                    const div = document.createElement('div');
                    div.className = 'flex gap-3 items-center';
                    div.innerHTML = `
                        <input type="text" value="${diskId}" class="p-2 border rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-teal-300" readonly>
                        <input type="file" id="rescanFolder_${diskId.replace(/[^a-zA-Z0-9]/g, '_')}" webkitdirectory directory multiple class="p-2 border rounded-lg">
                        <button onclick="rescanDisk('${diskId.replace(/'/g, "\\'")}')" class="bg-teal-500 text-white p-2 rounded-lg hover:bg-teal-600 transition tooltip" data-tooltip="Rescan this disk for new files">Rescan</button>
                    `;
                    diskList.appendChild(div);
                });
            } catch (error) {
                console.error('Failed to load disks:', error);
                alert('Error loading disks. Please check Firebase configuration and try again.');
            }
        }

        async function addProgramme() {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.setDoc || !window.firebase.doc || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            const name = document.getElementById('newProgramme').value.trim();
            if (!name) {
                alert('Please enter a programme name.');
                return;
            }
            try {
                const snapshot = await window.firebase.getDocs(window.firebase.query(window.firebase.collection(window.firebase.firestore, 'programmes'), window.firebase.where('name', '==', name.toLowerCase())));
                if (!snapshot.empty) {
                    alert(`Programme "${name}" already exists.`);
                    return;
                }
                const id = window.firebase.doc(window.firebase.collection(window.firebase.firestore, 'programmes')).id;
                await window.firebase.setDoc(window.firebase.doc(window.firebase.firestore, 'programmes', id), { id, name });
                document.getElementById('newProgramme').value = '';
                alert(`Programme "${name}" added!`);
            } catch (error) {
                console.error('Failed to add programme:', error);
                alert('Error adding programme. Please try again.');
            }
        }

        async function editProgramme(id, button) {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.updateDoc || !window.firebase.doc || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            const input = button.previousElementSibling;
            if (button.textContent === 'Edit') {
                input.removeAttribute('readonly');
                button.textContent = 'Save';
                button.className = 'bg-teal-500 text-white p-2 rounded-lg hover:bg-teal-600 transition tooltip';
                button.setAttribute('data-tooltip', 'Save programme name');
            } else {
                const newName = input.value.trim();
                if (!newName) {
                    alert('Please enter a programme name.');
                    return;
                }
                try {
                    const snapshot = await window.firebase.getDocs(window.firebase.query(window.firebase.collection(window.firebase.firestore, 'programmes'), window.firebase.where('name', '==', newName.toLowerCase())));
                    if (!snapshot.empty && snapshot.docs[0].id !== id) {
                        alert(`Programme "${newName}" already exists.`);
                        return;
                    }
                    await window.firebase.updateDoc(window.firebase.doc(window.firebase.firestore, 'programmes', id), { name: newName });
                    input.setAttribute('readonly', true);
                    button.textContent = 'Edit';
                    button.className = 'bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600 transition tooltip';
                    button.setAttribute('data-tooltip', 'Edit programme');
                    alert(`Programme updated to "${newName}"!`);
                } catch (error) {
                    console.error('Failed to edit programme:', error);
                    alert('Error editing programme. Please try again.');
                }
            }
        }

        async function deleteProgramme(id) {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.deleteDoc || !window.firebase.doc || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            if (!confirm('Are you sure you want to delete this programme?')) return;
            try {
                await window.firebase.deleteDoc(window.firebase.doc(window.firebase.firestore, 'programmes', id));
                alert('Programme deleted!');
            } catch (error) {
                console.error('Failed to delete programme:', error);
                alert('Error deleting programme. Please try again.');
            }
        }

        function toggleOtherProgrammeInput(select) {
            const otherInput = document.getElementById('otherProgramme');
            otherInput.classList.toggle('hidden', select.value !== 'Other');
            if (select.value === 'Other') {
                otherInput.focus();
            }
        }

        function isExcluded(filePath) {
            const fileName = filePath.split('/').pop();
            if (EXCLUDE_PREFIXES.some(prefix => fileName.startsWith(prefix))) return true;
            if (!VIDEO_EXTENSIONS.some(ext => fileName.toLowerCase().endsWith(ext))) return true;
            return EXCLUDE_DIRS.some(dir => filePath.includes(dir));
        }

        async function scanDisk(diskId = null) {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.setDoc || !window.firebase.doc || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            const inputDiskId = diskId || document.getElementById('diskId').value.trim();
            const diskFolder = diskId ? document.getElementById(`rescanFolder_${diskId.replace(/[^a-zA-Z0-9]/g, '_')}`) : document.getElementById('diskFolder');
            if (!inputDiskId) {
                alert('Please enter a Disk ID.');
                return;
            }
            if (!diskFolder.files.length) {
                alert('Please select a folder.');
                return;
            }

            const progressBar = document.getElementById('scanProgress');
            const progressFill = document.getElementById('progressFill');
            progressBar.classList.add('active');
            progressFill.style.width = '0%';

            const scannedTable = document.getElementById('scannedTable');
            scannedTable.innerHTML = '';
            currentFiles = Array.from(diskFolder.files);

            try {
                const newFiles = [];
                const existingFiles = new Set();
                const snapshot = await window.firebase.getDocs(window.firebase.collection(window.firebase.firestore, 'files'));
                const fileDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                fileDocs.forEach(file => existingFiles.add(normalizePath(file.filePath)));
                console.log('Existing files in Firestore:', Array.from(existingFiles));

                const nonArchivedFiles = [];
                currentFiles.forEach((file, index) => {
                    const relativePath = normalizePath(file.webkitRelativePath);
                    if (!isExcluded(relativePath)) {
                        if (!existingFiles.has(relativePath)) {
                            window.firebase.setDoc(window.firebase.doc(window.firebase.firestore, 'files', sanitizeId(relativePath)), {
                                filePath: relativePath,
                                diskId: inputDiskId,
                                metadata: {}
                            })
                                .then(() => console.log('Added new file:', relativePath))
                                .catch(error => console.error('Error adding file:', relativePath, error));
                            newFiles.push(relativePath);
                        }
                        nonArchivedFiles.push({ filePath: relativePath, file });
                        progressFill.style.width = `${((index + 1) / currentFiles.length) * 100}%`;
                    } else {
                        console.log('Excluded file during scan:', relativePath);
                    }
                });

                const snapshot2 = await window.firebase.getDocs(window.firebase.query(window.firebase.collection(window.firebase.firestore, 'files'), window.firebase.where('metadata', '==', {})));
                const untaggedFiles = snapshot2.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Untagged files in Firestore:', untaggedFiles.map(f => ({ filePath: f.filePath, metadata: f.metadata })));

                const displayFiles = nonArchivedFiles
                    .filter(f => untaggedFiles.some(doc => normalizePath(doc.filePath) === f.filePath))
                    .sort((a, b) => a.filePath.localeCompare(b.filePath, undefined, { sensitivity: 'base' }));

                console.log('Files to display in Scanned Files tab:', displayFiles.map(f => f.filePath));

                const problemFile = "chiriyude vazhi/chiriyude vazhi-ep-01-917-imx-06.mov";
                const normalizedProblemFile = normalizePath(problemFile);
                const problemFileDoc = fileDocs.find(doc => normalizePath(doc.filePath) === normalizedProblemFile);
                if (problemFileDoc) {
                    console.warn(`Problematic file "${problemFile}" found in Firestore:`, {
                        filePath: problemFileDoc.filePath,
                        metadata: problemFileDoc.metadata,
                        isTagged: Object.keys(problemFileDoc.metadata).length > 0
                    });
                    if (Object.keys(problemFileDoc.metadata).length > 0) {
                        console.warn(`File "${problemFile}" is tagged but appearing in Scanned Files. Metadata:`, problemFileDoc.metadata);
                    }
                } else {
                    console.warn(`File "${problemFile}" not found in Firestore.`);
                }

                displayFiles.forEach(({ filePath, file }) => {
                    const row = document.createElement('tr');
                    row.dataset.filePath = filePath;
                    row.innerHTML = `
                        <td class="file-path-column p-3 border">${filePath}</td>
                        <td class="actions-column p-3 border">
                            <button onclick="editMetadata('${filePath.replace(/'/g, "\\'")}')" 
                                    class="bg-teal-500 text-white p-1 rounded-lg hover:bg-teal-600 transition tooltip" data-tooltip="Edit metadata and play">
                                Edit Metadata
                            </button>
                        </td>
                    `;
                    scannedTable.appendChild(row);
                });

                progressBar.classList.remove('active');
                if (newFiles.length > 0) {
                    alert(`New files added from folder and subfolders: ${newFiles.join(', ')}\nEdit metadata in the 'Scanned Files' section to archive them.`);
                } else {
                    alert('No new files found during scan.');
                }
                alert('Scan completed!');
                await loadFiles();
                await loadDisks();
                showTab('scannedTab');
            } catch (error) {
                console.error('Failed to scan disk:', error);
                progressBar.classList.remove('active');
                alert('Error scanning disk. Please check Firebase configuration and try again.');
            }
        }

        function rescanDisk(diskId) {
            scanDisk(diskId);
        }

        async function editMetadata(filePath) {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.doc || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            const normalizedPath = normalizePath(filePath);
            document.getElementById('metadataFilePath').value = normalizedPath;
            const programName = document.getElementById('programName');
            const otherProgramme = document.getElementById('otherProgramme');
            const episodeNumber = document.getElementById('episodeNumber');
            const episodeDetails = document.getElementById('episodeDetails');
            const telecastDate = document.getElementById('telecastDate');
            const customFields = document.getElementById('customFields');
            const videoPlayerContainer = document.getElementById('videoPlayerContainer');
            const videoPlayer = document.getElementById('videoPlayer');
            const grammarSuggestions = document.getElementById('grammarSuggestions');

            if (videoPlayer.src) {
                URL.revokeObjectURL(videoPlayer.src);
                videoPlayer.src = '';
            }
            grammarSuggestions.classList.add('hidden');
            grammarSuggestions.innerHTML = '';

            customFields.innerHTML = `
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" placeholder="Custom Field Name" class="p-2 border rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-teal-300" data-key>
                    <input type="text" placeholder="Value" class="p-2 border rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-teal-300" data-value>
                    <button onclick="removeCustomField(this)" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition tooltip" data-tooltip="Remove this field">Remove</button>
                </div>
            `;

            const file = currentFiles.find(f => normalizePath(f.webkitRelativePath) === normalizedPath);
            if (file) {
                videoPlayer.src = URL.createObjectURL(file);
                videoPlayerContainer.classList.remove('hidden');
            } else {
                videoPlayerContainer.classList.add('hidden');
                alert('Video file not found. Please reselect the folder containing this file.');
            }

            try {
                const snapshot = await window.firebase.getDocs(window.firebase.query(window.firebase.collection(window.firebase.firestore, 'files'), window.firebase.where('filePath', '==', filePath)));
                if (snapshot.empty) {
                    alert('File not found in Firestore.');
                    return;
                }
                const file = snapshot.docs[0].data();
                if (file && Object.keys(file.metadata).length > 0) {
                    const progName = file.metadata['Name of Programme'] || '';
                    programName.value = progName;
                    if (programName.options.namedItem(progName)) {
                        otherProgramme.value = '';
                        otherProgramme.classList.add('hidden');
                    } else {
                        programName.value = 'Other';
                        otherProgramme.value = progName;
                        otherProgramme.classList.remove('hidden');
                    }
                    episodeNumber.value = file.metadata['Episode Number'] || '';
                    episodeDetails.value = file.metadata['Episode Details'] || '';
                    telecastDate.value = file.metadata['Telecast Date'] || '';
                    customFields.innerHTML = '';
                    Object.entries(file.metadata).forEach(([key, value]) => {
                        if (!['Name of Programme', 'Episode Number', 'Episode Details', 'Telecast Date'].includes(key)) {
                            const div = document.createElement('div');
                            div.className = 'flex flex-col sm:flex-row gap-3';
                            div.innerHTML = `
                                <input type="text" value="${key}" class="p-2 border rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-teal-300" data-key>
                                <input type="text" value="${value}" class="p-2 border rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-teal-300" data-value>
                                <button onclick="removeCustomField(this)" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition tooltip" data-tooltip="Remove this field">Remove</button>
                            `;
                            customFields.appendChild(div);
                        }
                    });
                } else {
                    programName.value = '';
                    otherProgramme.value = '';
                    otherProgramme.classList.add('hidden');
                    episodeNumber.value = '';
                    episodeDetails.value = '';
                    telecastDate.value = '';
                }
                showTab('metadataTab');
                document.getElementById('metadataTab').scrollIntoView({ behavior: 'smooth' });
                programName.focus();
            } catch (error) {
                console.error('Failed to load metadata:', error);
                alert('Error loading metadata. Please check Firebase configuration and try again.');
            }
        }

        function addCustomField() {
            const customFields = document.getElementById('customFields');
            const div = document.createElement('div');
            div.className = 'flex flex-col sm:flex-row gap-3';
            div.innerHTML = `
                <input type="text" placeholder="Custom Field Name" class="p-2 border rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-teal-300" data-key>
                <input type="text" placeholder="Value" class="p-2 border rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-teal-300" data-value>
                <button onclick="removeCustomField(this)" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition tooltip" data-tooltip="Remove this field">Remove</button>
            `;
            customFields.appendChild(div);
        }

        function removeCustomField(button) {
            button.parentElement.remove();
        }

        async function saveMetadata() {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.updateDoc || !window.firebase.doc || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            const filePath = document.getElementById('metadataFilePath').value.trim();
            if (!filePath) {
                alert('Please select a file to edit metadata.');
                return;
            }

            try {
                const normalizedPath = normalizePath(filePath);
                const snapshot = await window.firebase.getDocs(window.firebase.query(window.firebase.collection(window.firebase.firestore, 'files'), window.firebase.where('filePath', '==', filePath)));
                if (snapshot.empty) {
                    alert('File not found!');
                    return;
                }
                const docRef = snapshot.docs[0].ref;
                const metadata = {};
                const programName = document.getElementById('programName').value;
                const otherProgramme = document.getElementById('otherProgramme').value.trim();
                const finalProgramName = programName === 'Other' ? otherProgramme : programName;
                if (finalProgramName) {
                    metadata['Name of Programme'] = finalProgramName;
                    if (programName === 'Other' && otherProgramme) {
                        const progSnapshot = await window.firebase.getDocs(window.firebase.query(window.firebase.collection(window.firebase.firestore, 'programmes'), window.firebase.where('name', '==', otherProgramme.toLowerCase())));
                        if (progSnapshot.empty) {
                            const id = window.firebase.doc(window.firebase.collection(window.firebase.firestore, 'programmes')).id;
                            await window.firebase.setDoc(window.firebase.doc(window.firebase.firestore, 'programmes', id), { id, name: otherProgramme });
                        }
                    }
                }
                const episodeNumber = document.getElementById('episodeNumber').value.trim();
                if (episodeNumber) metadata['Episode Number'] = episodeNumber;
                const episodeDetails = document.getElementById('episodeDetails').value.trim();
                if (episodeDetails) metadata['Episode Details'] = toSentenceCase(episodeDetails);
                const telecastDate = document.getElementById('telecastDate').value.trim();
                if (telecastDate) metadata['Telecast Date'] = telecastDate;

                document.querySelectorAll('#customFields div').forEach(div => {
                    const key = div.querySelector('[data-key]').value.trim();
                    const value = div.querySelector('[data-value]').value.trim();
                    if (key && value) metadata[key] = value;
                });

                await window.firebase.updateDoc(docRef, { metadata });
                const videoPlayer = document.getElementById('videoPlayer');
                if (videoPlayer.src) {
                    URL.revokeObjectURL(videoPlayer.src);
                    videoPlayer.src = '';
                }
                document.getElementById('grammarSuggestions').classList.add('hidden');
                alert(`Metadata saved for "${filePath.split('/').pop()}". Updated in 'Archived Files'.`);
                const scannedTable = document.getElementById('scannedTable');
                const rows = Array.from(scannedTable.querySelectorAll('tr'));
                const currentRow = rows.find(row => normalizePath(row.dataset.filePath) === normalizedPath);
                if (currentRow) currentRow.remove();
                if (rows.length > 1) {
                    const nextRow = rows.find(row => normalizePath(row.dataset.filePath) !== normalizedPath);
                    if (nextRow) {
                        const nextFilePath = nextRow.dataset.filePath;
                        await editMetadata(nextFilePath);
                    }
                } else {
                    alert('All scanned files have been archived!');
                    showTab('scannedTab');
                }
                document.getElementById('metadataTab').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Failed to save metadata:', error);
                alert('Error saving metadata. Please check Firebase configuration and try again.');
            }
        }

        async function loadFiles() {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            try {
                const snapshot = await window.firebase.getDocs(window.firebase.collection(window.firebase.firestore, 'files'));
                console.log('Files fetched:', snapshot.size, snapshot.docs.map(doc => ({ filePath: doc.data().filePath, diskId: doc.data().diskId, metadata: doc.data().metadata })));
                const files = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                const tableBody = document.getElementById('fileTable');
                tableBody.innerHTML = '';

                const filesWithMetadata = files
                    .filter(file => Object.keys(file.metadata).length > 0)
                    .sort((a, b) => {
                        const progA = a.metadata['Name of Programme'] || '';
                        const progB = b.metadata['Name of Programme'] || '';
                        if (progA !== progB) {
                            return progA.localeCompare(progB, undefined, { sensitivity: 'base' });
                        }
                        const epA = parseInt(a.metadata['Episode Number'] || '0', 10);
                        const epB = parseInt(b.metadata['Episode Number'] || '0', 10);
                        return epA - epB;
                    });

                const currentFilePaths = currentFiles.map(f => normalizePath(f.webkitRelativePath));
                console.log('Current scanned file paths:', currentFilePaths);

                filesWithMetadata.forEach(file => {
                    const normalizedPath = normalizePath(file.filePath);
                    const metadataStr = Object.entries(file.metadata)
                        .map(([k, v]) => `${k}: ${v}`)
                        .join('; ');
                    const isAccessible = currentFilePaths.includes(normalizedPath);
                    if (!isAccessible) {
                        console.warn(`File marked offline: ${file.filePath} (normalized: ${normalizedPath}) not found in current files.`);
                    }
                    const row = document.createElement('tr');
                    row.className = isAccessible ? 'bg-green-100' : 'bg-red-100';
                    row.setAttribute('data-tooltip', isAccessible ? 'File accessible' : 'File not found, reselect folder or update path');
                    row.classList.add('tooltip');
                    row.innerHTML = `
                        <td class="file-path-column p-3 border">${file.filePath}</td>
                        <td class="disk-id-column p-3 border">${file.diskId}</td>
                        <td class="metadata-column p-3 border">${metadataStr}</td>
                        <td class="actions-column p-3 border">
                            <button onclick="editMetadata('${file.filePath.replace(/'/g, "\\'")}')" class="bg-teal-500 text-white p-1 rounded-lg hover:bg-teal-600 transition tooltip" data-tooltip="Edit metadata">Edit</button>
                            <button onclick="playVideoInSearch('${file.filePath.replace(/'/g, "\\'")}')" class="bg-teal-500 text-white p-1 rounded-lg hover:bg-teal-600 transition tooltip" data-tooltip="Play video">Play</button>
                            <button onclick="copyFile('${file.filePath.replace(/'/g, "\\'")}')" class="bg-gray-500 text-white p-1 rounded-lg hover:bg-gray-600 transition tooltip" data-tooltip="Copy file to destination">Copy</button>
                            ${!isAccessible ? `<button onclick="updateFilePath('${file.filePath.replace(/'/g, "\\'")}', '${file.diskId.replace(/'/g, "\\'")}')" class="bg-yellow-500 text-white p-1 rounded-lg hover:bg-yellow-600 transition tooltip" data-tooltip="Update file path">Update Path</button>` : ''}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                const problemFile = "chiriyude vazhi/chiriyude vazhi-ep-01-917-imx-06.mov";
                const normalizedProblemFile = normalizePath(problemFile);
                const problemFileData = files.find(f => normalizePath(f.filePath) === normalizedProblemFile);
                if (problemFileData) {
                    console.log(`Status of "${problemFile}":`, {
                        filePath: problemFileData.filePath,
                        diskId: problemFileData.diskId,
                        metadata: problemFileData.metadata,
                        isTagged: Object.keys(problemFileData.metadata).length > 0,
                        isAccessible: currentFilePaths.includes(normalizedProblemFile)
                    });
                } else {
                    console.log(`File "${problemFile}" not found in Firestore.`);
                }
            } catch (error) {
                console.error('Failed to load files:', error);
                alert('Error loading files. Please check Firebase configuration and try again.');
            }
        }

        function playVideoInSearch(filePath) {
            const normalizedPath = normalizePath(filePath);
            const file = currentFiles.find(f => normalizePath(f.webkitRelativePath) === normalizedPath);
            const videoPlayer = document.getElementById('videoPlayer');
            if (videoPlayer.src) {
                URL.revokeObjectURL(videoPlayer.src);
                videoPlayer.src = '';
            }
            if (file) {
                videoPlayer.src = URL.createObjectURL(file);
                showTab('metadataTab');
                document.getElementById('metadataTab').scrollIntoView({ behavior: 'smooth' });
            } else {
                console.warn(`Cannot play video: ${filePath} (normalized: ${normalizedPath}) not found in current files.`);
                alert('Video file not found. Please reselect the folder containing this file or update the file path.');
            }
        }

        function copyFile(filePath) {
            const normalizedPath = normalizePath(filePath);
            const file = currentFiles.find(f => normalizePath(f.webkitRelativePath) === normalizedPath);
            if (!file) {
                console.warn(`Cannot copy file: ${filePath} (normalized: ${normalizedPath}) not found in current files.`);
                alert('Video file not found. Please reselect the folder containing this file or update the file path.');
                return;
            }

            const copyDestination = document.getElementById('copyDestination');
            copyDestination.value = '';
            copyDestination.onchange = function () {
                const destinationPath = copyDestination.files.length ? copyDestination.files[0].webkitRelativePath.split('/')[0] : '';
                if (!destinationPath) {
                    alert('Please select a destination folder.');
                    return;
                }
                const fileName = normalizedPath.split('/').pop();
                const link = document.createElement('a');
                link.href = URL.createObjectURL(file);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                alert(`File "${fileName}" is ready to download. Please save it to the selected destination folder: ${destinationPath}`);
                copyDestination.value = '';
            };
            copyDestination.click();
        }

        async function searchFiles() {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.query || !window.firebase.where || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            const diskId = document.getElementById('searchDiskId').value.trim();
            const programName = document.getElementById('searchProgramName').value.trim();
            const episodeNumber = document.getElementById('searchEpisodeNumber').value.trim();
            const telecastDate = document.getElementById('searchTelecastDate').value.trim();
            const searchMetadata = document.getElementById('searchMetadata').value.trim().toLowerCase();
            const searchLogic = document.getElementById('searchLogic').value;

            try {
                let q = window.firebase.collection(window.firebase.firestore, 'files');
                const conditions = [];
                if (diskId) conditions.push(window.firebase.where('diskId', '==', diskId));
                if (programName) conditions.push(window.firebase.where('metadata.Name of Programme', '==', programName));
                if (episodeNumber) conditions.push(window.firebase.where('metadata.Episode Number', '==', episodeNumber));
                if (telecastDate) conditions.push(window.firebase.where('metadata.Telecast Date', '==', telecastDate));
                if (conditions.length > 0) q = window.firebase.query(q, ...conditions);

                const snapshot = await window.firebase.getDocs(q);
                const files = snapshot.docs.map(doc => doc.data()).filter(file => {
                    if (!Object.keys(file.metadata).length) return false;
                    if (searchMetadata) {
                        return Object.entries(file.metadata).some(([key, value]) =>
                            key.toLowerCase().includes(searchMetadata) ||
                            value.toLowerCase().includes(searchMetadata)
                        );
                    }
                    return true;
                }).filter(file => {
                    const diskMatch = !diskId || file.diskId.toLowerCase() === diskId.toLowerCase();
                    const programMatch = !programName || (file.metadata['Name of Programme'] && file.metadata['Name of Programme'].toLowerCase() === programName.toLowerCase());
                    const episodeMatch = !episodeNumber || (file.metadata['Episode Number'] && file.metadata['Episode Number'] === episodeNumber);
                    const dateMatch = !telecastDate || (file.metadata['Telecast Date'] && file.metadata['Telecast Date'] === telecastDate);
                    if (searchLogic === 'AND') {
                        return (diskId ? diskMatch : true) &&
                            (programName ? programMatch : true) &&
                            (episodeNumber ? episodeMatch : true) &&
                            (telecastDate ? dateMatch : true);
                    } else {
                        return (diskId && diskMatch) ||
                            (programName && programMatch) ||
                            (episodeNumber && episodeMatch) ||
                            (telecastDate && dateMatch);
                    }
                }).sort((a, b) => {
                    const progA = a.metadata['Name of Programme'] || '';
                    const progB = b.metadata['Name of Programme'] || '';
                    if (progA !== progB) {
                        return progA.localeCompare(progB, undefined, { sensitivity: 'base' });
                    }
                    const epA = parseInt(a.metadata['Episode Number'] || '0', 10);
                    const epB = parseInt(b.metadata['Episode Number'] || '0', 10);
                    return epA - epB;
                });

                const tableBody = document.getElementById('fileTable');
                tableBody.innerHTML = '';

                let alertMessage = files.length ? `Found ${files.length} file(s): ` : 'No files match your search.';
                if (files.length) {
                    const matches = files.map(file => `Disk ID: ${file.diskId}, Path: ${file.filePath}`).join('; ');
                    alertMessage += matches;
                }
                alert(alertMessage);

                const currentFilePaths = currentFiles.map(f => normalizePath(f.webkitRelativePath));
                files.forEach(file => {
                    const normalizedPath = normalizePath(file.filePath);
                    const metadataStr = Object.entries(file.metadata)
                        .map(([k, v]) => `${k}: ${v}`)
                        .join('; ');
                    const isAccessible = currentFilePaths.includes(normalizedPath);
                    if (!isAccessible) {
                        console.warn(`Search result marked offline: ${file.filePath} (normalized: ${normalizedPath}) not found in current files.`);
                    }
                    const row = document.createElement('tr');
                    row.className = isAccessible ? 'bg-green-100' : 'bg-red-100';
                    row.setAttribute('data-tooltip', isAccessible ? 'File accessible' : 'File not found, reselect folder or update path');
                    row.classList.add('tooltip');
                    row.innerHTML = `
                        <td class="file-path-column p-3 border">${file.filePath}</td>
                        <td class="disk-id-column p-3 border">${file.diskId}</td>
                        <td class="metadata-column p-3 border">${metadataStr}</td>
                        <td class="actions-column p-3 border">
                            <button onclick="editMetadata('${file.filePath.replace(/'/g, "\\'")}')" class="bg-teal-500 text-white p-1 rounded-lg hover:bg-teal-600 transition tooltip" data-tooltip="Edit metadata">Edit</button>
                            <button onclick="playVideoInSearch('${file.filePath.replace(/'/g, "\\'")}')" class="bg-teal-500 text-white p-1 rounded-lg hover:bg-teal-600 transition tooltip" data-tooltip="Play video">Play</button>
                            <button onclick="copyFile('${file.filePath.replace(/'/g, "\\'")}')" class="bg-gray-500 text-white p-1 rounded-lg hover:bg-gray-600 transition tooltip" data-tooltip="Copy file to destination">Copy</button>
                            ${!isAccessible ? `<button onclick="updateFilePath('${file.filePath.replace(/'/g, "\\'")}', '${file.diskId.replace(/'/g, "\\'")}')" class="bg-yellow-500 text-white p-1 rounded-lg hover:bg-yellow-600 transition tooltip" data-tooltip="Update file path">Update Path</button>` : ''}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Failed to search files:', error);
                alert('Error searching files. Please check Firebase configuration and try again.');
            }
        }

        async function exportReport() {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            try {
                const snapshot = await window.firebase.getDocs(window.firebase.collection(window.firebase.firestore, 'files'));
                const files = snapshot.docs.map(doc => doc.data());
                const filesWithMetadata = files.filter(file => Object.keys(file.metadata).length > 0);

                const metadataKeys = new Set(['Name of Programme', 'Episode Number', 'Episode Details', 'Telecast Date']);
                filesWithMetadata.forEach(file => {
                    Object.keys(file.metadata).forEach(key => metadataKeys.add(key));
                });
                const headers = ['Relative File Path', 'Disk ID', ...metadataKeys];

                let csvContent = 'data:text/csv;charset=utf-8,' + headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + '\n';
                filesWithMetadata.forEach(file => {
                    const normalizedPath = normalizePath(file.filePath);
                    const row = [
                        `"${file.filePath.replace(/"/g, '""')}"`,
                        `"${file.diskId.replace(/"/g, '""')}"`,
                        ...headers.slice(2).map(key => {
                            const value = file.metadata[key] || '';
                            return `"${value.replace(/"/g, '""').replace(/\n/g, ' ')}"`;
                        })
                    ];
                    csvContent += row.join(',') + '\n';
                });

                const link = document.createElement('a');
                link.setAttribute('href', encodeURI(csvContent));
                link.setAttribute('download', 'video_metadata_report.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert('Report exported as CSV!');
            } catch (error) {
                console.error('Failed to export report:', error);
                alert('Error exporting report. Please check Firebase configuration and try again.');
            }
        }

        async function backupData() {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.collection) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            try {
                const backupData = { files: [], programmes: [] };
                const [fileSnapshot, progSnapshot] = await Promise.all([
                    window.firebase.getDocs(window.firebase.collection(window.firebase.firestore, 'files')),
                    window.firebase.getDocs(window.firebase.collection(window.firebase.firestore, 'programmes'))
                ]);
                backupData.files = fileSnapshot.docs.map(doc => doc.data());
                backupData.programmes = progSnapshot.docs.map(doc => doc.data());

                const jsonContent = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(backupData, null, 2));
                const link = document.createElement('a');
                link.setAttribute('href', jsonContent);
                link.setAttribute('download', 'video_manager_backup.json');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                alert('Data backed up as video_manager_backup.json!');
            } catch (error) {
                console.error('Failed to backup data:', error);
                alert('Error backing up data. Please check Firebase configuration and try again.');
            }
        }

        async function restoreData() {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.getDocs || !window.firebase.setDoc || !window.firebase.doc || !window.firebase.collection || !window.firebase.writeBatch) {
                console.error('Firestore not initialized.');
                alert('Firestore is not initialized. Please check Firebase configuration and reload the page.');
                return;
            }
            const restoreInput = document.getElementById('restoreInput');
            if (!restoreInput.files.length) {
                alert('Please select a JSON backup file.');
                return;
            }
            if (!confirm('Restoring data will overwrite existing data. Continue?')) return;

            const file = restoreInput.files[0];
            const reader = new FileReader();
            reader.onload = async function (event) {
                try {
                    const data = JSON.parse(event.target.result);
                    const batch = window.firebase.writeBatch(window.firebase.firestore);
                    const fileSnapshot = await window.firebase.getDocs(window.firebase.collection(window.firebase.firestore, 'files'));
                    fileSnapshot.forEach(doc => batch.delete(doc.ref));
                    data.files.forEach(file => {
                        const normalizedPath = normalizePath(file.filePath);
                        batch.set(window.firebase.doc(window.firebase.firestore, 'files', sanitizeId(normalizedPath)), {
                            ...file,
                            filePath: normalizedPath
                        });
                    });
                    const progSnapshot = await window.firebase.getDocs(window.firebase.collection(window.firebase.firestore, 'programmes'));
                    progSnapshot.forEach(doc => batch.delete(doc.ref));
                    data.programmes.forEach(prog => {
                        batch.set(window.firebase.doc(window.firebase.firestore, 'programmes', prog.id), prog);
                    });
                    await batch.commit();
                    await loadProgrammes();
                    await loadFiles();
                    await loadDisks();
                    restoreInput.value = '';
                    alert('Data restored successfully!');
                } catch (error) {
                    console.error('Failed to restore data:', error);
                    alert('Error restoring data. Please check the JSON file or Firebase configuration and try again.');
                }
            };
            reader.readAsText(file);
        }

        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error('XLSX Error:', e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
    </script>
</body>

</html>
